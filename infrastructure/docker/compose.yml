version: "3.9"

services:
  gateway:
    build:
      context: ../..
      dockerfile: services/gateway/Dockerfile
    environment:
      - GATEWAY_PORT=8000
      - DEEPAGENTS_URL=http://deepagents:9004
      - DEEP_RESEARCH_URL=http://deep-research:2024
      # Model Configuration - LocalAI only (no external LLM dependencies)
      - LOCALAI_URL=http://localai:8080
    ports:
      - "8000:8000"
    depends_on:
      - deepagents
      - catalog

  postgres:
    image: ankane/pgvector:latest
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=amodels
    ports:
      - "5432:5432"

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  opensearch:
    image: opensearchproject/opensearch:2.14.0
    environment:
      - discovery.type=single-node
      - plugins.security.disabled=true
      - OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    ports:
      - "9200:9200"
      - "9600:9600"

  neo4j:
    image: neo4j:5.23
    environment:
      - NEO4J_AUTH=neo4j/password
      - NEO4J_PLUGINS=["graph-data-science"]
    ports:
      - "7687:7687"
      - "7474:7474"
    volumes:
      - neo4j_data:/data

  localai:
    image: quay.io/go-skynet/local-ai:latest
    environment:
      - MODELS_PATH=/models
      - THREADS=${LOCALAI_THREADS:-4}
      - CONTEXT_SIZE=${LOCALAI_CONTEXT:-2048}
      - DEBUG=${LOCALAI_DEBUG:-false}
    ports:
      - "8081:8080"
    volumes:
      - ../../models:/models:ro

  catalog:
    build:
      context: ../..
      dockerfile: services/catalog/Dockerfile
    environment:
      - PORT=8084
      - RUN_MIGRATIONS=${RUN_MIGRATIONS:-true}
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USERNAME=neo4j
      - NEO4J_PASSWORD=password
      - CATALOG_BASE_URI=http://catalog:8084
      - EXTRACT_SERVICE_URL=http://extract-service:19080
      - GRAPH_SERVICE_URL=http://graph-service:8081
      - LOCALAI_URL=http://localai:8080
      - DEEP_RESEARCH_URL=http://deep-research:2024
      - REDIS_URL=redis://redis:6379/0
      - SQL_MIGRATIONS_DRIVER=postgres
      - SQL_MIGRATIONS_DSN=postgres://postgres:postgres@postgres:5432/amodels?sslmode=disable
      - CATALOG_DATABASE_URL=postgres://postgres:postgres@postgres:5432/amodels?sslmode=disable
    ports:
      - "8084:8084"
    depends_on:
      - neo4j
      - postgres
      - redis
      - localai

  deepagents:
    build:
      context: ../..
      dockerfile: services/deepagents/Dockerfile
    environment:
      - EXTRACT_SERVICE_URL=http://extract-service:19080
      - AGENTFLOW_SERVICE_URL=http://agentflow-service:9001
      - GRAPH_SERVICE_URL=http://graph-service:8081
      # Model Configuration - LocalAI only (no external LLM dependencies)
      - LOCALAI_URL=http://localai:8080
      # Disable external LLM providers
      - ANTHROPIC_API_KEY=
      - OPENAI_API_KEY=
      - DEEPAGENTS_PORT=9004
      # DeepAgents is enabled by default (10/10 integration)
      # Set DEEPAGENTS_ENABLED=false to disable
      - DEEPAGENTS_ENABLED=${DEEPAGENTS_ENABLED:-true}
    ports:
      - "9004:9004"
    depends_on:
      - postgres
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9004/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  deep-research:
    build:
      context: ../..
      dockerfile: infrastructure/docker/deep-research/Dockerfile
    environment:
      # Catalog Integration (for tools)
      - CATALOG_URL=http://catalog:8084
      - CATALOG_SPARQL_URL=http://catalog:8084/catalog/sparql
      # Model Configuration - LocalAI only (no external LLM dependencies)
      - LOCALAI_URL=http://localai:8080
      # Disable external LLM providers
      - ANTHROPIC_API_KEY=
      - OPENAI_API_KEY=
      # Search API (optional - can use Tavily or none)
      - SEARCH_API=${SEARCH_API:-none}
      - TAVILY_API_KEY=${TAVILY_API_KEY:-}
      # Research Configuration
      - MAX_RESEARCHER_ITERATIONS=${MAX_RESEARCHER_ITERATIONS:-6}
      - MAX_CONCURRENT_RESEARCH_UNITS=${MAX_CONCURRENT_RESEARCH_UNITS:-5}
      - ALLOW_CLARIFICATION=${ALLOW_CLARIFICATION:-true}
      # LangGraph Configuration
      - LANGGRAPH_API_KEY=${LANGGRAPH_API_KEY:-}
    ports:
      - "8085:2024"
    depends_on:
      - catalog
      - localai
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2024/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  neo4j_data:
