# BCRS to Capital Liquidity ETL Pipeline Definition
# ETL process from BCRS credit exposures to capital liquidity calculations

pipeline:
  id: "bcrs-to-capital-etl"
  name: "BCRS Credit Exposures to Capital Liquidity"
  version: "1.0.0"
  description: "ETL process from BCRS credit exposures to capital liquidity calculations"
  
  source:
    type: "bcrs"
    connection: "bcrs-connection"
    schema:
      fields:
        - name: "exposure_id"
          type: "string"
        - name: "counterparty_id"
          type: "string"
        - name: "exposure_amount"
          type: "decimal"
        - name: "exposure_date"
          type: "date"
        - name: "risk_weight"
          type: "decimal"
        - name: "risk_weighted_amount"
          type: "decimal"
        - name: "regulatory_capital"
          type: "decimal"
        - name: "economic_capital"
          type: "decimal"
        - name: "rating"
          type: "string"
    filters:
      exposure_date: ">= TODAY - 7 days"
  
  steps:
    - id: "extract-credit-exposures"
      name: "Extract Credit Exposures"
      type: "extract"
      description: "Extract credit exposures from BCRS"
      config:
        table: "credit_exposures"
        batch_size: 1000
        filters:
          exposure_date: ">= TODAY - 7 days"
      on_error: "stop"
      retries: 3
    
    - id: "aggregate-by-counterparty"
      name: "Aggregate by Counterparty"
      type: "aggregate"
      description: "Aggregate exposures by counterparty"
      config:
        group_by:
          - "counterparty_id"
          - "exposure_date"
        aggregations:
          - field: "exposure_amount"
            function: "sum"
            alias: "total_exposure"
          - field: "risk_weighted_amount"
            function: "sum"
            alias: "total_rwa"
          - field: "regulatory_capital"
            function: "sum"
            alias: "total_regulatory_capital"
          - field: "economic_capital"
            function: "sum"
            alias: "total_economic_capital"
          - field: "exposure_id"
            function: "count"
            alias: "exposure_count"
      on_error: "stop"
    
    - id: "calculate-capital-ratios"
      name: "Calculate Capital Ratios"
      type: "transform"
      description: "Calculate capital adequacy ratios"
      config:
        transformations:
          - field: "capital_ratio"
            type: "calculate"
            formula: "total_regulatory_capital / total_rwa"
            source_fields: ["total_regulatory_capital", "total_rwa"]
          - field: "tier1_ratio"
            type: "calculate"
            formula: "tier1_capital / total_rwa"
            source_fields: ["tier1_capital", "total_rwa"]
          - field: "leverage_ratio"
            type: "calculate"
            formula: "tier1_capital / total_exposure"
            source_fields: ["tier1_capital", "total_exposure"]
      on_error: "warn"
    
    - id: "calculate-liquidity-metrics"
      name: "Calculate Liquidity Metrics"
      type: "transform"
      description: "Calculate liquidity risk metrics"
      config:
        transformations:
          - field: "liquidity_coverage_ratio"
            type: "calculate"
            formula: "high_quality_liquid_assets / net_cash_outflows_30d"
            source_fields: ["high_quality_liquid_assets", "net_cash_outflows_30d"]
          - field: "net_stable_funding_ratio"
            type: "calculate"
            formula: "available_stable_funding / required_stable_funding"
            source_fields: ["available_stable_funding", "required_stable_funding"]
      on_error: "warn"
    
    - id: "enrich-with-counterparty-data"
      name: "Enrich with Counterparty Data"
      type: "enrich"
      description: "Enrich with counterparty rating and risk data"
      config:
        lookup_table: "counterparty_master"
        lookup_key: "counterparty_id"
        lookup_fields:
          - "counterparty_name"
          - "sector"
          - "country"
          - "rating"
      on_error: "warn"
    
    - id: "validate-data"
      name: "Validate Capital Calculations"
      type: "validate"
      description: "Validate capital and liquidity calculations"
      config:
        rules:
          - field: "total_exposure"
            check: ">= 0"
          - field: "total_rwa"
            check: ">= 0"
          - field: "total_regulatory_capital"
            check: ">= 0"
          - field: "capital_ratio"
            check: ">= 0.08"  # Minimum 8% capital ratio
          - field: "liquidity_coverage_ratio"
            check: ">= 1.0"  # Minimum 100% LCR
      on_error: "stop"
    
    - id: "format-for-capital-reporting"
      name: "Format for Capital Reporting"
      type: "transform"
      description: "Format data for capital liquidity reporting"
      config:
        transformations:
          - field: "report_date"
            type: "date_format"
            source: "exposure_date"
            format: "YYYY-MM-DD"
          - field: "amounts_rounded"
            type: "round_multiple"
            fields: ["total_exposure", "total_rwa", "total_regulatory_capital"]
            decimals: 2
      on_error: "warn"
  
  target:
    type: "capital_liquidity"
    connection: "capital-connection"
    schema:
      fields:
        - name: "counterparty_id"
          type: "string"
        - name: "report_date"
          type: "date"
        - name: "total_exposure"
          type: "decimal"
        - name: "total_rwa"
          type: "decimal"
        - name: "total_regulatory_capital"
          type: "decimal"
        - name: "total_economic_capital"
          type: "decimal"
        - name: "capital_ratio"
          type: "decimal"
        - name: "liquidity_coverage_ratio"
          type: "decimal"
        - name: "net_stable_funding_ratio"
          type: "decimal"
      primary_key:
        - "counterparty_id"
        - "report_date"
  
  validation:
    schema_validation: true
    data_quality_gates:
      - name: "completeness"
        metric: "completeness"
        threshold: 0.95
        operator: ">="
        on_failure: "stop"
        description: "95% of credit exposures must be successfully processed"
      
      - name: "accuracy"
        metric: "accuracy"
        threshold: 0.95
        operator: ">="
        on_failure: "stop"
        description: "95% accuracy threshold for capital calculations"
      
      - name: "regulatory_compliance"
        metric: "compliance"
        threshold: 1.0
        operator: ">="
        on_failure: "stop"
        description: "100% regulatory compliance (capital ratios meet minimums)"
    
    consistency_checks:
      - name: "capital_ratio_minimum"
        type: "threshold_check"
        field: "capital_ratio"
        threshold: 0.08
        operator: ">="
        description: "Capital ratio must meet minimum 8% requirement"
      
      - name: "lcr_minimum"
        type: "threshold_check"
        field: "liquidity_coverage_ratio"
        threshold: 1.0
        operator: ">="
        description: "Liquidity Coverage Ratio must meet minimum 100% requirement"
  
  schedule:
    frequency: "0 3 * * *"  # Daily at 3 AM
    timezone: "UTC"
  
  error_handling:
    retries: 3
    backoff: "exponential"
    max_backoff: 120
    alert_on_failure: true
    alert_channels:
      - "email"
      - "slack"
      - "pagerduty"
  
  metadata:
    owner: "Risk Management"
    steward: "risk-steward@example.com"
    created_at: "2025-01-XX"
    updated_at: "2025-01-XX"

