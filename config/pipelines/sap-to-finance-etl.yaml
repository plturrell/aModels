# SAP to Finance Reporting ETL Pipeline Definition
# ETL process from SAP GL to Finance Reporting

pipeline:
  id: "sap-to-finance-etl"
  name: "SAP GL to Finance Reporting"
  version: "1.0.0"
  description: "ETL process from SAP GL journal entries to finance reporting"
  
  source:
    type: "sap_gl"
    connection: "sap-connection"
    schema:
      fields:
        - name: "entry_id"
          type: "string"
        - name: "entry_date"
          type: "date"
        - name: "posting_date"
          type: "date"
        - name: "account"
          type: "string"
        - name: "debit_amount"
          type: "decimal"
        - name: "credit_amount"
          type: "decimal"
        - name: "currency"
          type: "string"
        - name: "fiscal_year"
          type: "integer"
        - name: "fiscal_period"
          type: "integer"
    filters:
      posting_date: ">= TODAY - 90 days"
  
  steps:
    - id: "extract-journal-entries"
      name: "Extract Journal Entries"
      type: "extract"
      description: "Extract journal entries from SAP GL"
      config:
        table: "journal_entries"
        batch_size: 5000
        filters:
          posting_date: ">= TODAY - 90 days"
      on_error: "stop"
      retries: 3
    
    - id: "aggregate-by-account"
      name: "Aggregate by Account"
      type: "aggregate"
      description: "Aggregate journal entries by account and period"
      config:
        group_by:
          - "account"
          - "fiscal_year"
          - "fiscal_period"
          - "currency"
        aggregations:
          - field: "debit_amount"
            function: "sum"
            alias: "total_debits"
          - field: "credit_amount"
            function: "sum"
            alias: "total_credits"
          - field: "entry_id"
            function: "count"
            alias: "entry_count"
      on_error: "stop"
    
    - id: "calculate-balances"
      name: "Calculate Account Balances"
      type: "transform"
      description: "Calculate opening, closing, and net balances"
      config:
        transformations:
          - field: "net_amount"
            type: "calculate"
            formula: "total_debits - total_credits"
            source_fields: ["total_debits", "total_credits"]
          - field: "closing_balance"
            type: "calculate"
            formula: "opening_balance + net_amount"
            source_fields: ["opening_balance", "net_amount"]
      on_error: "stop"
    
    - id: "enrich-with-account-info"
      name: "Enrich with Account Information"
      type: "enrich"
      description: "Enrich with account name, type, and hierarchy"
      config:
        lookup_table: "account_master"
        lookup_key: "account"
        lookup_fields:
          - "account_name"
          - "account_type"
          - "account_category"
          - "parent_account"
      on_error: "warn"
    
    - id: "map-to-finance-chart"
      name: "Map to Finance Chart of Accounts"
      type: "transform"
      description: "Map SAP accounts to finance reporting chart of accounts"
      config:
        mapping_table: "sap_to_finance_account_mapping"
        source_key: "account"
        target_fields:
          - "finance_account_code"
          - "finance_account_name"
          - "reporting_category"
      on_error: "warn"
    
    - id: "validate-data"
      name: "Validate Finance Reporting Data"
      type: "validate"
      description: "Validate data meets finance reporting requirements"
      config:
        rules:
          - field: "account"
            check: "required"
          - field: "fiscal_year"
            check: "required"
          - field: "fiscal_period"
            check: "required"
            check: ">= 1"
            check: "<= 12"
          - field: "total_debits"
            check: ">= 0"
          - field: "total_credits"
            check: ">= 0"
          - field: "net_amount"
            check: "balance_check"
            tolerance: 0.01
      on_error: "stop"
    
    - id: "format-for-reporting"
      name: "Format for Finance Reporting"
      type: "transform"
      description: "Format data for finance reporting format"
      config:
        transformations:
          - field: "report_date"
            type: "date_format"
            source: "posting_date"
            format: "YYYY-MM-DD"
          - field: "amount_rounded"
            type: "round"
            source: "net_amount"
            decimals: 2
      on_error: "warn"
  
  target:
    type: "finance_reporting"
    connection: "finance-connection"
    schema:
      fields:
        - name: "account"
          type: "string"
        - name: "account_name"
          type: "string"
        - name: "finance_account_code"
          type: "string"
        - name: "fiscal_year"
          type: "integer"
        - name: "fiscal_period"
          type: "integer"
        - name: "currency"
          type: "string"
        - name: "total_debits"
          type: "decimal"
        - name: "total_credits"
          type: "decimal"
        - name: "net_amount"
          type: "decimal"
        - name: "closing_balance"
          type: "decimal"
        - name: "reporting_category"
          type: "string"
      primary_key:
        - "account"
        - "fiscal_year"
        - "fiscal_period"
        - "currency"
  
  validation:
    schema_validation: true
    data_quality_gates:
      - name: "completeness"
        metric: "completeness"
        threshold: 0.98
        operator: ">="
        on_failure: "stop"
        description: "98% of journal entries must be successfully processed"
      
      - name: "accuracy"
        metric: "accuracy"
        threshold: 0.99
        operator: ">="
        on_failure: "stop"
        description: "99% accuracy threshold for finance reporting"
      
      - name: "balance_consistency"
        metric: "consistency"
        threshold: 0.99
        operator: ">="
        on_failure: "stop"
        description: "99% of balances must be consistent"
    
    consistency_checks:
      - name: "debit_credit_balance"
        type: "sum"
        source_field: "total_debits"
        target_field: "total_credits"
        tolerance: 0.01
        description: "Total debits and credits must balance within tolerance"
      
      - name: "account_balance_consistency"
        type: "cross_period_consistency"
        field: "closing_balance"
        description: "Closing balance should match next period opening balance"
  
  schedule:
    frequency: "0 2 * * *"  # Daily at 2 AM
    timezone: "UTC"
  
  error_handling:
    retries: 3
    backoff: "exponential"
    max_backoff: 120
    alert_on_failure: true
    alert_channels:
      - "email"
      - "slack"
      - "pagerduty"
  
  metadata:
    owner: "Finance Operations"
    steward: "finance-steward@example.com"
    created_at: "2025-01-XX"
    updated_at: "2025-01-XX"

