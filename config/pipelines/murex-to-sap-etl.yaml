# Murex to SAP ETL Pipeline Definition
# ETL process from Murex trades to SAP GL journal entries

pipeline:
  id: "murex-to-sap-etl"
  name: "Murex Trades to SAP Journal Entries"
  version: "1.0.0"
  description: "ETL process from Murex trades to SAP GL journal entries"
  
  source:
    type: "murex"
    connection: "murex-connection"
    schema:
      fields:
        - name: "trade_id"
          type: "string"
        - name: "trade_date"
          type: "date"
        - name: "notional_amount"
          type: "decimal"
        - name: "currency"
          type: "string"
        - name: "counterparty_id"
          type: "string"
    filters:
      status: "executed"
      trade_date: ">= TODAY - 7 days"
  
  steps:
    - id: "extract-trades"
      name: "Extract Executed Trades"
      type: "extract"
      description: "Extract executed trades from Murex"
      config:
        table: "trades"
        batch_size: 1000
        filters:
          status: "executed"
      on_error: "stop"
      retries: 3
    
    - id: "transform-to-journal"
      name: "Transform to Journal Entry Format"
      type: "transform"
      description: "Transform Murex trade data to SAP journal entry format"
      config:
        mapping:
          trade_id: "entry_id"
          trade_date: "entry_date"
          notional_amount: "debit_amount"
          currency: "currency"
          counterparty_id: "account"
        transformations:
          - field: "entry_id"
            type: "format"
            format: "JE-{trade_id}"
          - field: "entry_date"
            type: "date_format"
            format: "YYYY-MM-DD"
      on_error: "stop"
    
    - id: "enrich-with-account"
      name: "Enrich with Account Mapping"
      type: "enrich"
      description: "Enrich with account mapping from counterparty"
      config:
        lookup_table: "counterparty_to_account"
        lookup_key: "counterparty_id"
        lookup_fields:
          - "account"
          - "account_type"
      on_error: "warn"
    
    - id: "validate-data"
      name: "Validate Transformed Data"
      type: "validate"
      description: "Validate transformed data meets SAP requirements"
      config:
        rules:
          - field: "entry_id"
            check: "required"
          - field: "debit_amount"
            check: "> 0"
          - field: "currency"
            check: "in_list"
            values: ["USD", "EUR", "GBP", "SGD"]
          - field: "account"
            check: "not_null"
      on_error: "stop"
    
    - id: "calculate-credit"
      name: "Calculate Credit Amount"
      type: "transform"
      description: "Calculate credit amount (equal to debit for single-sided entries)"
      config:
        transformations:
          - field: "credit_amount"
            type: "copy"
            source: "debit_amount"
      on_error: "stop"
  
  target:
    type: "sap_gl"
    connection: "sap-connection"
    schema:
      fields:
        - name: "entry_id"
          type: "string"
        - name: "entry_date"
          type: "date"
        - name: "account"
          type: "string"
        - name: "debit_amount"
          type: "decimal"
        - name: "credit_amount"
          type: "decimal"
        - name: "currency"
          type: "string"
        - name: "description"
          type: "string"
      primary_key:
        - "entry_id"
  
  validation:
    schema_validation: true
    data_quality_gates:
      - name: "completeness"
        metric: "completeness"
        threshold: 0.95
        operator: ">="
        on_failure: "stop"
        description: "95% of trades must be successfully transformed"
      
      - name: "accuracy"
        metric: "accuracy"
        threshold: 0.90
        operator: ">="
        on_failure: "warn"
        description: "90% accuracy threshold for transformations"
      
      - name: "freshness"
        metric: "freshness"
        threshold: 0.95
        operator: ">="
        on_failure: "warn"
        description: "95% of trades processed within 24 hours"
    
    consistency_checks:
      - name: "amount_balance"
        type: "sum"
        source_field: "debit_amount"
        target_field: "credit_amount"
        tolerance: 0.01
        description: "Debit and credit amounts must balance"
      
      - name: "row_count"
        type: "row_count"
        source_count: "murex.trades"
        target_count: "sap.journal_entries"
        tolerance: 0.05
        description: "Row count should match within 5%"
  
  schedule:
    frequency: "*/15 * * * *"  # Every 15 minutes
    timezone: "UTC"
  
  error_handling:
    retries: 3
    backoff: "exponential"
    max_backoff: 60
    alert_on_failure: true
    alert_channels:
      - "email"
      - "slack"
  
  metadata:
    owner: "Finance Operations"
    steward: "finance-steward@example.com"
    created_at: "2025-01-XX"
    updated_at: "2025-01-XX"

