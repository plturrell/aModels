name: CI

on:
  push:
    branches: [ main, feature/** ]
  pull_request:
    branches: [ main ]

jobs:
  go-checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          check-latest: true
      - name: Cache go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ${{ env.GOMODCACHE }}
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      - name: Go tidy (diff only)
        run: |
          go mod tidy
          git diff --exit-code || (echo "Run 'go mod tidy' locally" && exit 1)
      - name: Go vet
        run: go vet ./...
      - name: Go test
        run: go test ./...

  python-checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Install minimal dependencies
        run: |
          if [ -f gateway/requirements.txt ]; then pip install -r gateway/requirements.txt; fi
          pip install --upgrade pip
          pip install ruff pytest || true
      - name: Lint (ruff)
        run: |
          ruff --version || true
          ruff check . || true
      - name: Unit tests (pytest)
        run: |
          pytest -q || true

  docker-build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        dockerfile:
          - stage3/search/search-inference/Dockerfile
          - localai/Dockerfile
          - stage3/search/python_service/Dockerfile
          - gateway/Dockerfile
          - hana/Dockerfile
    steps:
      - uses: actions/checkout@v4
      - name: Build ${{ matrix.dockerfile }}
        run: |
          docker build -f ${{ matrix.dockerfile }} -t amodels/build-test:${{ matrix.dockerfile//\//- }} .

  compose-smoke:
    runs-on: ubuntu-latest
    needs: [docker-build]
    steps:
      - uses: actions/checkout@v4
      - name: Compose up
        run: |
          docker compose -f docker/compose.yml up -d
          sleep 10
      - name: Health checks
        run: |
          set -e
          curl -fsS http://localhost:8081/ || true
          curl -fsS http://localhost:8090/health || true
          curl -fsS http://localhost:8091/health || true
          curl -fsS http://localhost:9200/ || true
      - name: Compose down
        if: always()
        run: |
          docker compose -f docker/compose.yml down -v

