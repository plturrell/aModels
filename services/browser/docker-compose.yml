version: '3.8'

# Full Browser UI Stack - Shell UI + Open Canvas + Extensions
# This builds and runs all browser-related services

services:
  # ============================================
  # Shell UI - Main Dashboard/Analytics
  # ============================================
  shell-ui:
    build:
      context: ../..
      dockerfile: services/browser/shell/Dockerfile.full
      args:
        - BUILD_DATE=${BUILD_DATE:-}
    container_name: amodels-shell-ui
    image: amodels/shell-ui:latest
    ports:
      - "4173:4173"
    environment:
      - SHELL_GATEWAY_URL=http://gateway:8000
      - SHELL_LOCALAI_URL=http://localai:8080
      - SHELL_DMS_ENDPOINT=http://dms:8084
      - SHELL_AGENTFLOW_ENDPOINT=http://agentflow:8086
      - SHELL_RUNTIME_ENDPOINT=http://runtime:8088
    networks:
      - amodels-network
    depends_on:
      - gateway
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4173/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # Open Canvas - AI Document/Code Editor
  # ============================================
  
  # Open Canvas Web Frontend (Next.js)
  opencanvas-web:
    build:
      context: ./open-canvas
      dockerfile: Dockerfile.web
    container_name: amodels-opencanvas-web
    image: amodels/opencanvas-web:latest
    ports:
      - "3000:3000"
    environment:
      # Feature flags
      - NEXT_PUBLIC_OPENAI_ENABLED=true
      - NEXT_PUBLIC_ANTHROPIC_ENABLED=false
      - NEXT_PUBLIC_FIREWORKS_ENABLED=false
      - NEXT_PUBLIC_GEMINI_ENABLED=false
      - NEXT_PUBLIC_AZURE_ENABLED=false
      - NEXT_PUBLIC_OLLAMA_ENABLED=false
      - NEXT_PUBLIC_GROQ_ENABLED=false
      # Supabase
      - NEXT_PUBLIC_SUPABASE_URL=${SUPABASE_URL:-http://supabase-kong:8000}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - NEXT_PUBLIC_SUPABASE_URL_DOCUMENTS=${SUPABASE_URL:-http://supabase-kong:8000}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY_DOCUMENTS=${SUPABASE_ANON_KEY}
      # LangGraph backend
      - NEXT_PUBLIC_LANGGRAPH_API_URL=http://opencanvas-agents:2024
    networks:
      - amodels-network
    depends_on:
      - opencanvas-agents
      - supabase-auth
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Open Canvas LangGraph Backend
  opencanvas-agents:
    build:
      context: ./open-canvas
      dockerfile: Dockerfile.agents
    container_name: amodels-opencanvas-agents
    image: amodels/opencanvas-agents:latest
    ports:
      - "2024:2024"
    environment:
      # LocalAI integration
      - OPENAI_API_KEY=sk-local-not-needed
      - OPENAI_API_BASE=http://localai:8080/v1
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      # LangSmith (optional)
      - LANGSMITH_TRACING=${LANGSMITH_TRACING:-false}
      - LANGSMITH_API_KEY=${LANGSMITH_API_KEY:-}
      # Supabase
      - NEXT_PUBLIC_SUPABASE_URL=${SUPABASE_URL:-http://supabase-kong:8000}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE=${SUPABASE_SERVICE_ROLE}
    networks:
      - amodels-network
    depends_on:
      - localai
      - supabase-auth
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2024/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # Browser Automation Service (Playwright)
  # ============================================
  browser-automation:
    build:
      context: ../..
      dockerfile: services/browser/Dockerfile
    container_name: amodels-browser-automation
    image: amodels/browser-automation:latest
    ports:
      - "8070:8070"
    environment:
      - PYTHONUNBUFFERED=1
      - PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
    networks:
      - amodels-network
    restart: unless-stopped
    shm_size: 2gb  # Required for Chromium
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8070/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # Supabase for Open Canvas Authentication
  # ============================================
  supabase-db:
    image: supabase/postgres:15.1.0.117
    container_name: amodels-supabase-db
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-your-super-secret-and-long-postgres-password}
      - POSTGRES_DB=postgres
    ports:
      - "54322:5432"
    volumes:
      - supabase-db-data:/var/lib/postgresql/data
    networks:
      - amodels-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  supabase-auth:
    image: supabase/gotrue:v2.99.0
    container_name: amodels-supabase-auth
    environment:
      - GOTRUE_API_HOST=0.0.0.0
      - GOTRUE_API_PORT=9999
      - API_EXTERNAL_URL=${API_EXTERNAL_URL:-http://localhost:8000}
      - GOTRUE_DB_DRIVER=postgres
      - GOTRUE_DB_DATABASE_URL=postgres://postgres:${POSTGRES_PASSWORD:-your-super-secret-and-long-postgres-password}@supabase-db:5432/postgres
      - GOTRUE_SITE_URL=${GOTRUE_SITE_URL:-http://localhost:3000}
      - GOTRUE_URI_ALLOW_LIST=http://localhost:3000,http://localhost:4173
      - GOTRUE_DISABLE_SIGNUP=false
      - GOTRUE_JWT_SECRET=${JWT_SECRET:-your-super-secret-jwt-token-with-at-least-32-characters-long}
      - GOTRUE_EXTERNAL_EMAIL_ENABLED=true
      - GOTRUE_MAILER_AUTOCONFIRM=true
    ports:
      - "9999:9999"
    networks:
      - amodels-network
    depends_on:
      supabase-db:
        condition: service_healthy
    restart: unless-stopped

  supabase-kong:
    image: kong:3.1.1
    container_name: amodels-supabase-kong
    environment:
      - KONG_DATABASE=off
      - KONG_DECLARATIVE_CONFIG=/var/lib/kong/kong.yml
      - KONG_DNS_ORDER=LAST,A,CNAME
      - KONG_PLUGINS=request-transformer,cors,key-auth,acl
    ports:
      - "8001:8000"  # HTTP (avoiding conflict with gateway on 8000)
    volumes:
      - ./supabase-config/kong.yml:/var/lib/kong/kong.yml:ro
    networks:
      - amodels-network
    restart: unless-stopped

  # ============================================
  # Supporting Services (External Dependencies)
  # ============================================
  
  # Note: These are referenced but should be started separately
  # via the main aModels infrastructure
  
  # gateway:
  #   external: true
  
  # localai:
  #   external: true
  
  # dms:
  #   external: true
  
  # agentflow:
  #   external: true
  
  # runtime:
  #   external: true

networks:
  amodels-network:
    external: true
    name: amodels-network

volumes:
  supabase-db-data:
    name: amodels-supabase-db-data
