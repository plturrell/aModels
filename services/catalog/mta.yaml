_schema-version: "3.1"
ID: amodels-catalog
version: 1.0.0
description: "aModels Catalog Service for SAP BTP"

modules:
  - name: amodels-catalog
    type: go
    path: .
    parameters:
      buildpack: go_buildpack
      memory: 512M
      disk-quota: 1G
      instances: 1
      health-check-type: http
      health-check-http-endpoint: /healthz
    requires:
      - name: amodels-catalog-xsuaa
      - name: amodels-catalog-postgres
      - name: amodels-catalog-redis
      - name: amodels-catalog-neo4j
    provides:
      - name: catalog-api
        properties:
          url: ${default-url}

resources:
  - name: amodels-catalog-xsuaa
    type: org.cloudfoundry.managed-service
    parameters:
      service: xsuaa
      service-plan: application
      config:
        xsappname: amodels-catalog
        tenant-mode: dedicated
        scopes:
          - name: $XSAPPNAME.Display
            description: Display catalog data elements and products
          - name: $XSAPPNAME.Edit
            description: Edit catalog data elements and products
          - name: $XSAPPNAME.Admin
            description: Administrative access to catalog service
          - name: $XSAPPNAME.DataProduct.Create
            description: Create new data products
          - name: $XSAPPNAME.DataProduct.Read
            description: Read data products
          - name: $XSAPPNAME.DataProduct.Update
            description: Update data products
          - name: $XSAPPNAME.DataProduct.Delete
            description: Delete data products
          - name: $XSAPPNAME.BreakDetection.Read
            description: Read break detection results
          - name: $XSAPPNAME.BreakDetection.Admin
            description: Administrative access to break detection
          - name: $XSAPPNAME.Analytics.Read
            description: Read analytics and dashboard data
        role-templates:
          - name: CatalogViewer
            description: View catalog data
            scope-references:
              - $XSAPPNAME.Display
              - $XSAPPNAME.DataProduct.Read
              - $XSAPPNAME.BreakDetection.Read
              - $XSAPPNAME.Analytics.Read
          - name: CatalogEditor
            description: Edit catalog data
            scope-references:
              - $XSAPPNAME.Display
              - $XSAPPNAME.Edit
              - $XSAPPNAME.DataProduct.Read
              - $XSAPPNAME.DataProduct.Create
              - $XSAPPNAME.DataProduct.Update
              - $XSAPPNAME.BreakDetection.Read
          - name: CatalogAdmin
            description: Full administrative access
            scope-references:
              - $XSAPPNAME.Display
              - $XSAPPNAME.Edit
              - $XSAPPNAME.Admin
              - $XSAPPNAME.DataProduct.Create
              - $XSAPPNAME.DataProduct.Read
              - $XSAPPNAME.DataProduct.Update
              - $XSAPPNAME.DataProduct.Delete
              - $XSAPPNAME.BreakDetection.Read
              - $XSAPPNAME.BreakDetection.Admin
              - $XSAPPNAME.Analytics.Read
        role-collections:
          - name: aModels_Catalog_Viewer
            description: View-only access to catalog service
            role-template-references:
              - $XSAPPNAME.CatalogViewer
          - name: aModels_Catalog_Editor
            description: Editor access to catalog service
            role-template-references:
              - $XSAPPNAME.CatalogEditor
          - name: aModels_Catalog_Admin
            description: Administrative access to catalog service
            role-template-references:
              - $XSAPPNAME.CatalogAdmin
        oauth2-configuration:
          token-validity: 3600
          system-attributes:
            - xs.system.attributes.xs.rolecollections

  - name: amodels-catalog-postgres
    type: org.cloudfoundry.managed-service
    parameters:
      service: postgresql
      service-plan: v12-dev

  - name: amodels-catalog-redis
    type: org.cloudfoundry.managed-service
    parameters:
      service: redis
      service-plan: cache

  - name: amodels-catalog-neo4j
    type: org.cloudfoundry.managed-service
    parameters:
      service: neo4j
      service-plan: aura

