openapi: 3.0.3
info:
  title: Perplexity Integration API
  description: |
    API for processing documents from Perplexity through OCR, catalog, training, local AI, and search.
    
    Features:
    - Sync and async document processing
    - Real-time progress tracking
    - Webhook notifications
    - Result export (JSON/CSV)
    - Request history and search
    - Batch operations
  version: 1.0.0
  contact:
    name: API Support
    url: https://github.com/plturrell/aModels

servers:
  - url: http://localhost:8080
    description: Local development server
  - url: https://api.example.com
    description: Production server

paths:
  /api/perplexity/process:
    post:
      summary: Process documents from Perplexity
      description: |
        Process documents from Perplexity API through the full pipeline:
        - Deep Research context understanding
        - OCR processing (if images present)
        - Catalog registration
        - Training export
        - Local AI storage
        - Search indexing
        - Pattern learning
        
        Supports both synchronous and asynchronous processing.
      operationId: processDocuments
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProcessRequest'
            examples:
              sync:
                summary: Synchronous processing
                value:
                  query: "latest research on AI"
                  limit: 5
                  include_images: true
              async:
                summary: Asynchronous processing with webhook
                value:
                  query: "latest research on AI"
                  async: true
                  webhook_url: "https://your-app.com/webhook"
      responses:
        '200':
          description: Processing completed (synchronous)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProcessResponse'
        '202':
          description: Job queued (asynchronous)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobQueuedResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/perplexity/status/{request_id}:
    get:
      summary: Get processing status
      description: Get the current status and progress of a processing request
      operationId: getStatus
      parameters:
        - name: request_id
          in: path
          required: true
          schema:
            type: string
          description: Request ID returned from process endpoint
      responses:
        '200':
          description: Status information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponse'
        '404':
          description: Request not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/perplexity/results/{request_id}:
    get:
      summary: Get processing results
      description: Get all processed documents and results for a request
      operationId: getResults
      parameters:
        - name: request_id
          in: path
          required: true
          schema:
            type: string
          description: Request ID returned from process endpoint
      responses:
        '200':
          description: Results information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResultsResponse'
        '404':
          description: Request not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/perplexity/results/{request_id}/export:
    get:
      summary: Export results
      description: Export processing results in JSON or CSV format
      operationId: exportResults
      parameters:
        - name: request_id
          in: path
          required: true
          schema:
            type: string
        - name: format
          in: query
          schema:
            type: string
            enum: [json, csv]
            default: json
          description: Export format
      responses:
        '200':
          description: Exported results
          content:
            application/json:
              schema:
                type: object
            text/csv:
              schema:
                type: string
        '404':
          description: Request not found

  /api/perplexity/jobs/{request_id}:
    delete:
      summary: Cancel a job
      description: Cancel a running or queued processing job
      operationId: cancelJob
      parameters:
        - name: request_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Job cancelled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CancelResponse'
        '400':
          description: Cannot cancel job
        '404':
          description: Job not found

  /api/perplexity/batch:
    post:
      summary: Batch process multiple queries
      description: Process multiple queries in parallel
      operationId: batchProcess
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BatchRequest'
      responses:
        '200':
          description: Batch processing results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchResponse'
        '400':
          description: Bad request

  /api/perplexity/history:
    get:
      summary: Get request history
      description: Get a list of previous processing requests with filtering and pagination
      operationId: getHistory
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
          description: Maximum number of results
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
          description: Pagination offset
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, processing, completed, failed, partial]
          description: Filter by status
        - name: query
          in: query
          schema:
            type: string
          description: Search query text
      responses:
        '200':
          description: Request history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HistoryResponse'

  /api/perplexity/learning/report:
    get:
      summary: Get learning report
      description: Get comprehensive learning metrics and patterns
      operationId: getLearningReport
      responses:
        '200':
          description: Learning report
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LearningReport'

components:
  schemas:
    ProcessRequest:
      type: object
      required:
        - query
      properties:
        query:
          type: string
          description: Search query for Perplexity API
          example: "latest research on AI"
        model:
          type: string
          description: Perplexity model to use
          example: "sonar"
        limit:
          type: integer
          description: Maximum number of documents to process
          default: 10
          minimum: 1
          maximum: 100
        include_images:
          type: boolean
          description: Include images in processing
          default: false
        async:
          type: boolean
          description: Process asynchronously
          default: false
        webhook_url:
          type: string
          format: uri
          description: Webhook URL for async completion notification
        config:
          type: object
          description: Additional configuration options

    ProcessResponse:
      type: object
      properties:
        status:
          type: string
          enum: [completed, partial, failed]
        request_id:
          type: string
        query:
          type: string
        statistics:
          $ref: '#/components/schemas/Statistics'
        processing_time_ms:
          type: integer
        document_ids:
          type: array
          items:
            type: string
        document_count:
          type: integer
        results:
          $ref: '#/components/schemas/ProcessingResults'
        progress:
          $ref: '#/components/schemas/Progress'
        errors:
          type: array
          items:
            $ref: '#/components/schemas/ProcessingError'
        warnings:
          type: array
          items:
            type: string
        status_url:
          type: string
        results_url:
          type: string

    JobQueuedResponse:
      type: object
      properties:
        status:
          type: string
          example: queued
        request_id:
          type: string
        query:
          type: string
        message:
          type: string
        status_url:
          type: string
        results_url:
          type: string

    StatusResponse:
      type: object
      properties:
        request_id:
          type: string
        query:
          type: string
        status:
          type: string
          enum: [pending, processing, completed, failed, partial]
        created_at:
          type: string
          format: date-time
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        current_step:
          type: string
        progress:
          $ref: '#/components/schemas/Progress'
        statistics:
          $ref: '#/components/schemas/Statistics'

    ResultsResponse:
      type: object
      properties:
        request_id:
          type: string
        query:
          type: string
        status:
          type: string
        statistics:
          $ref: '#/components/schemas/Statistics'
        documents:
          type: array
          items:
            $ref: '#/components/schemas/ProcessedDocument'
        results:
          $ref: '#/components/schemas/ProcessingResults'
        processing_time_ms:
          type: integer

    ProcessedDocument:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        status:
          type: string
          enum: [success, failed]
        processed_at:
          type: string
          format: date-time
        catalog_id:
          type: string
        training_task_id:
          type: string
        localai_id:
          type: string
        search_id:
          type: string
        error:
          type: string
        metadata:
          type: object

    Statistics:
      type: object
      properties:
        documents_processed:
          type: integer
        documents_succeeded:
          type: integer
        documents_failed:
          type: integer
        steps_completed:
          type: integer

    Progress:
      type: object
      properties:
        current_step:
          type: string
        completed_steps:
          type: array
          items:
            type: string
        total_steps:
          type: integer
        progress_percent:
          type: number
          format: float
        estimated_time_remaining_ms:
          type: integer

    ProcessingResults:
      type: object
      properties:
        catalog_url:
          type: string
        search_url:
          type: string
        training_url:
          type: string
        localai_url:
          type: string
        export_url:
          type: string

    ProcessingError:
      type: object
      properties:
        step:
          type: string
        message:
          type: string
        timestamp:
          type: string
          format: date-time
        document_id:
          type: string
        error_code:
          type: string
        recovery_steps:
          type: array
          items:
            type: string
        retryable:
          type: boolean

    BatchRequest:
      type: object
      required:
        - queries
      properties:
        queries:
          type: array
          items:
            $ref: '#/components/schemas/ProcessRequest'
          minItems: 1
          maxItems: 50
        async:
          type: boolean
          default: true
        webhook_url:
          type: string
          format: uri

    BatchResponse:
      type: object
      properties:
        batch_id:
          type: string
        total_queries:
          type: integer
        request_ids:
          type: array
          items:
            type: string
        status:
          type: string
        status_url:
          type: string

    HistoryResponse:
      type: object
      properties:
        requests:
          type: array
          items:
            $ref: '#/components/schemas/HistoryItem'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    HistoryItem:
      type: object
      properties:
        request_id:
          type: string
        query:
          type: string
        status:
          type: string
        created_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        document_count:
          type: integer

    LearningReport:
      type: object
      properties:
        metrics:
          type: object
        learned_patterns:
          type: object
        recommendations:
          type: array
          items:
            type: string

    CancelResponse:
      type: object
      properties:
        status:
          type: string
          example: cancelled
        request_id:
          type: string
        message:
          type: string

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        request_id:
          type: string

